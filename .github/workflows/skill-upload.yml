name: Upload Skill

on:
  push:
    paths:
      - 'uploads/**.zip'

permissions:
  contents: write
  pull-requests: write

jobs:
  upload-skill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.27.2/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Process All Skill Uploads
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Find all zip files in uploads directory
          ZIP_FILES=$(find uploads -name "*.zip" -type f 2>/dev/null || true)

          if [ -z "$ZIP_FILES" ]; then
            echo "========================================="
            echo "No .zip files found in uploads directory."
            echo "This is normal if:"
            echo "  - Zip files were already processed"
            echo "  - Zip files were manually deleted"
            echo "  - Only non-zip files were modified"
            echo "Exiting gracefully."
            echo "========================================="
            exit 0
          fi

          # Count how many files we're processing
          FILE_COUNT=$(echo "$ZIP_FILES" | wc -l)
          echo "Found $FILE_COUNT skill(s) to process"

          # Configure git once for all operations
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Store the main branch name
          MAIN_BRANCH=$(git branch --show-current)

          # Process each zip file
          COUNTER=1
          echo "$ZIP_FILES" | while IFS= read -r ZIP_FILE; do
            echo ""
            echo "========================================="
            echo "Processing skill $COUNTER of $FILE_COUNT: $ZIP_FILE"
            echo "========================================="

            # Extract the zip file
            TEMP_DIR=$(mktemp -d)
            unzip "$ZIP_FILE" -d "$TEMP_DIR/extracted_skill"
            echo "Extracted files:"
            ls -R "$TEMP_DIR/extracted_skill"

            EXTRACTED_PATH="$TEMP_DIR/extracted_skill"

            # Handle case where zip contains a single root directory
            # Count items in extracted path
            ITEM_COUNT=$(find "$EXTRACTED_PATH" -mindepth 1 -maxdepth 1 | wc -l)
            if [ "$ITEM_COUNT" -eq 1 ]; then
              SINGLE_ITEM=$(find "$EXTRACTED_PATH" -mindepth 1 -maxdepth 1)
              if [ -d "$SINGLE_ITEM" ]; then
                echo "Zip contains single root directory, using it as base path"
                EXTRACTED_PATH="$SINGLE_ITEM"
              fi
            fi

            echo "Using path: $EXTRACTED_PATH"

            # Validate: Check for SKILL.md and extract metadata
            SKILL_MD_PATH="$EXTRACTED_PATH/SKILL.md"
            if [ ! -f "$SKILL_MD_PATH" ]; then
              echo "Error: SKILL.md not found in $ZIP_FILE!"
              echo "Expected at: $SKILL_MD_PATH"
              rm -rf "$TEMP_DIR"
              exit 1
            fi

            # Extract YAML frontmatter
            FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "$SKILL_MD_PATH" | sed '1d;$d')
            SKILL_NAME=$(echo "$FRONTMATTER" | yq eval '.name' -)
            SKILL_DESCRIPTION=$(echo "$FRONTMATTER" | yq eval '.description' -)

            if [ -z "$SKILL_NAME" ] || [ "$SKILL_NAME" == "null" ]; then
              echo "Error: Skill name not found in SKILL.md frontmatter for $ZIP_FILE"
              rm -rf "$TEMP_DIR"
              exit 1
            fi

            echo "Skill name: $SKILL_NAME"
            echo "Description: $SKILL_DESCRIPTION"

            # Security Validations
            echo "Running security checks..."

            # Path Traversal Check
            if find "$EXTRACTED_PATH" -type f | grep -q '/\.\./'; then
              echo "Error: Path traversal detected in $ZIP_FILE"
              rm -rf "$TEMP_DIR"
              exit 1
            fi

            # File Type Check - Block dangerous executables and archives
            BLOCKED_EXTENSIONS=("exe" "dll" "so" "dylib" "bin" "app" "bat" "cmd" "vbs" "ps1" "jar" "zip" "tar" "gz" "7z" "rar" "dmg" "iso" "msi" "deb" "rpm")
            for file in $(find "$EXTRACTED_PATH" -type f); do
              extension="${file##*.}"
              # Convert to lowercase for comparison
              extension_lower=$(echo "$extension" | tr '[:upper:]' '[:lower:]')
              if [[ " ${BLOCKED_EXTENSIONS[@]} " =~ " ${extension_lower} " ]]; then
                echo "Error: Blocked file type found in $ZIP_FILE: $file"
                echo "Blocked extensions: executables, binaries, archives, and system scripts"
                rm -rf "$TEMP_DIR"
                exit 1
              fi
            done

            # Zip Bomb check
            MAX_FILES=1000
            EXTRACTED_FILE_COUNT=$(find "$EXTRACTED_PATH" -type f | wc -l)
            if [ "$EXTRACTED_FILE_COUNT" -gt "$MAX_FILES" ]; then
              echo "Error: Too many files in $ZIP_FILE (max $MAX_FILES)"
              rm -rf "$TEMP_DIR"
              exit 1
            fi

            echo "Security checks passed!"

            # Prepare skill directory name
            SKILL_DIR_NAME=$(echo "$SKILL_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
            echo "Skill directory: $SKILL_DIR_NAME"

            # Create unique branch name for this skill (includes run ID to avoid conflicts)
            BRANCH_NAME="skill-upload/$SKILL_DIR_NAME-$RUN_ID"
            echo "Creating branch: $BRANCH_NAME"

            git checkout -b "$BRANCH_NAME"

            # Copy skill files
            rsync -av --delete "$EXTRACTED_PATH/" "$SKILL_DIR_NAME/"

            # Add the new skill files and remove the original zip file
            git add "$SKILL_DIR_NAME"
            git rm "$ZIP_FILE"

            git commit -m "feat(skills): Add/Update skill: $SKILL_NAME"
            git push origin "$BRANCH_NAME"

            # Create Pull Request
            gh pr create \
              --title "feat(skills): Add/Update skill: $SKILL_NAME" \
              --body-file - <<-EOF
            Automated skill upload for **$SKILL_NAME**.

            **Description:** $SKILL_DESCRIPTION

            *This PR was generated automatically from the file \`$ZIP_FILE\`.*
          EOF

            echo "âœ“ Successfully created PR for $SKILL_NAME"

            # Clean up temp directory
            rm -rf "$TEMP_DIR"

            # Return to main branch for next iteration
            git checkout "$MAIN_BRANCH"

            COUNTER=$((COUNTER + 1))
          done

          echo ""
          echo "========================================="
          echo "All skills processed successfully!"
          echo "========================================="
