name: Perch

on:
  # Schedule disabled during testing -- uncomment when stable
  # schedule:
  #   - cron: '0 12 * * *'     # sleep at 7am ET
  #   - cron: '0 13 * * *'     # zeitgeist at 8am ET
  workflow_dispatch:
    inputs:
      task:
        description: Task to run
        default: sleep
        type: choice
        options:
          - sleep
          - zeitgeist
          - fly
      model:
        description: Model
        default: claude-haiku-4-5-20251001
        type: choice
        options:
          - claude-haiku-4-5-20251001
          - claude-sonnet-4-5-20250929
      verbose:
        description: Verbose logging
        default: true
        type: boolean
      max_turns:
        description: Max tool-call turns (safety ceiling)
        default: '50'

jobs:
  perch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Check required secrets
        env:
          HAS_ANTHROPIC: ${{ secrets.ANTHROPIC_API_KEY != '' }}
          HAS_TURSO_TOKEN: ${{ secrets.TURSO_TOKEN != '' }}
          HAS_TURSO_URL: ${{ secrets.TURSO_URL != '' }}
        run: |
          ok=true
          if [ "$HAS_ANTHROPIC" != "true" ]; then
            echo "::error::ANTHROPIC_API_KEY secret is not set"
            ok=false
          fi
          if [ "$HAS_TURSO_TOKEN" != "true" ]; then
            echo "::warning::TURSO_TOKEN secret is not set (memory tools will fail)"
          fi
          if [ "$HAS_TURSO_URL" != "true" ]; then
            echo "::warning::TURSO_URL secret is not set (memory tools will fail)"
          fi
          if [ "$ok" != "true" ]; then
            echo "::error::Required secrets missing. See Settings > Secrets and variables > Actions."
            exit 1
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic requests

      - name: Run perch
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TURSO_TOKEN: ${{ secrets.TURSO_TOKEN }}
          TURSO_URL: ${{ secrets.TURSO_URL }}
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_APP_PASSWORD: ${{ secrets.BSKY_APP_PASSWORD }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          VERBOSE_FLAG=""
          if [ "${{ inputs.verbose }}" = "true" ]; then
            VERBOSE_FLAG="--verbose"
          else
            VERBOSE_FLAG="--quiet"
          fi
          python .perch/perch.py \
            --task ${{ inputs.task }} \
            --model "${{ inputs.model }}" \
            --max-turns ${{ inputs.max_turns }} \
            $VERBOSE_FLAG

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: perch-${{ inputs.task }}-${{ github.run_number }}
          path: |
            session.log
            session.json
          retention-days: 30
