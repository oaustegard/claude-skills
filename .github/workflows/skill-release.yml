name: Release Skill

on:
  push:
    branches:
      - main
    paths:
      - '*/VERSION'
  workflow_dispatch:
    inputs:
      skill_name:
        description: 'Skill folder name to release'
        required: true
        type: string
      version:
        description: 'Version number (will use VERSION file if not specified)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release-skill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Detect Changed Skills
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input parameter
            echo "skills=${{ inputs.skill_name }}" >> $GITHUB_OUTPUT
          else
            # Auto-detect from push - find VERSION files that changed
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^[^/]*/VERSION$' | cut -d'/' -f1 | tr '\n' ' ')
            if [ -z "$CHANGED" ]; then
              echo "No VERSION files changed"
              echo "skills=" >> $GITHUB_OUTPUT
            else
              echo "skills=$CHANGED" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Release Each Skill
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SKILLS="${{ steps.detect.outputs.skills }}"

          if [ -z "$SKILLS" ]; then
            echo "========================================="
            echo "No skills to release"
            echo "========================================="
            exit 0
          fi

          echo "Skills to release: $SKILLS"

          for SKILL_DIR in $SKILLS; do
            echo ""
            echo "========================================="
            echo "Processing: $SKILL_DIR"
            echo "========================================="

            # Validate skill directory exists
            if [ ! -d "$SKILL_DIR" ]; then
              echo "Error: Directory $SKILL_DIR does not exist"
              exit 1
            fi

            # Read version from file or input
            if [ -n "${{ inputs.version }}" ]; then
              VERSION="${{ inputs.version }}"
              echo "Using manual version: $VERSION"
            else
              if [ ! -f "$SKILL_DIR/VERSION" ]; then
                echo "Error: No VERSION file found in $SKILL_DIR"
                exit 1
              fi
              VERSION=$(cat "$SKILL_DIR/VERSION" | tr -d '[:space:]')
              echo "Using VERSION file: $VERSION"
            fi

            # Validate version format (basic semver check)
            if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "Error: Invalid version format '$VERSION' (expected semver like 1.0.0)"
              exit 1
            fi

            # Construct tag and release names
            TAG_NAME="$SKILL_DIR-v$VERSION"
            RELEASE_TITLE="$SKILL_DIR v$VERSION"

            echo "Tag: $TAG_NAME"
            echo "Title: $RELEASE_TITLE"

            # Check if release already exists
            if gh release view "$TAG_NAME" &>/dev/null; then
              echo "âš ï¸  Release $TAG_NAME already exists, skipping"
              continue
            fi

            # Validate skill structure
            if [ ! -f "$SKILL_DIR/SKILL.md" ]; then
              echo "Error: No SKILL.md found in $SKILL_DIR"
              exit 1
            fi

            echo "âœ“ Skill structure validated"

            # Save repository root before changing directories
            REPO_ROOT=$(pwd)

            # Create ZIP with correct structure
            # The ZIP should contain the skill folder as its root
            TEMP_DIR=$(mktemp -d)
            echo "Creating ZIP in temp directory: $TEMP_DIR"

            # Copy skill folder to temp directory
            cp -r "$SKILL_DIR" "$TEMP_DIR/"

            # Create ZIP from temp directory (exclude VERSION - it's workflow metadata)
            cd "$TEMP_DIR"
            zip -r "$SKILL_DIR.zip" "$SKILL_DIR/" -x "$SKILL_DIR/VERSION" "$SKILL_DIR/README.md"

            echo "âœ“ Created $SKILL_DIR.zip"
            echo "ZIP contents:"
            unzip -l "$SKILL_DIR.zip" | head -20

            # Return to repository root for git operations
            cd "$REPO_ROOT"

            # Prepare release description content from README
            SKILL_README_CONTENT=$(cat "$SKILL_DIR/README.md" 2>/dev/null || echo "No README found for this skill.")
            SKILL_FOLDER_URL="https://github.com/${{ github.repository }}/tree/main/$SKILL_DIR"
            SKILL_DESCRIPTION_HEADER=$(cat <<EOF
$SKILL_README_CONTENT

**Skill folder:** [$SKILL_DIR]($SKILL_FOLDER_URL)
EOF
)

            # Generate release notes
            # Try to get last tag for this skill
            LAST_TAG=$(git tag -l "$SKILL_DIR-v*" | sort -V | tail -n1 || echo "")

            if [ -n "$LAST_TAG" ]; then
              echo "Generating changelog from $LAST_TAG to HEAD"
              CHANGELOG=$(git log --oneline "$LAST_TAG..HEAD" -- "$SKILL_DIR/" | head -10 || echo "No changes found")
            else
              echo "No previous release found, using recent commits"
              CHANGELOG=$(git log --oneline HEAD~5..HEAD -- "$SKILL_DIR/" | head -10 || echo "Initial release")
            fi

            # Construct direct download URL
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/$SKILL_DIR.zip"

            # Create release notes
            RELEASE_NOTES=$(cat <<EOF
          $SKILL_DESCRIPTION_HEADER

          ---

          Release of **$SKILL_DIR** version $VERSION

          ## ðŸ“¥ Download & Install

          **[â¬‡ï¸ Download $SKILL_DIR.zip]($DOWNLOAD_URL)**

          To install:
          1. Click the download link above (ignore the "Source code" archives below - they're auto-generated by GitHub)
          2. Go to [Claude.ai Skills Settings](https://claude.ai/settings/capabilities)
          3. Upload the downloaded ZIP file
          4. Requires paid Claude Pro or Team account

          See [official documentation](https://support.claude.com/en/articles/12512198-how-to-create-custom-skills) for more details.

          ## Recent Changes
          \`\`\`
          $CHANGELOG
          \`\`\`
          EOF
          )

            # Create GitHub release
            echo "Creating GitHub release..."
            gh release create "$TAG_NAME" \
              "$TEMP_DIR/$SKILL_DIR.zip" \
              --title "$RELEASE_TITLE" \
              --notes "$RELEASE_NOTES"

            if [ $? -eq 0 ]; then
              echo "âœ“ Successfully released $SKILL_DIR v$VERSION"
              echo "   View at: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
            else
              echo "âœ— Failed to create release for $SKILL_DIR"
              exit 1
            fi

            # Clean up temp directory
            rm -rf "$TEMP_DIR"

            echo ""
          done

          echo "========================================="
          echo "All releases completed successfully!"
          echo "========================================="
